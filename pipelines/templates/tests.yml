# [Template] Run MRTK tests.

parameters:
  UnityVersion: ""

steps:
- powershell: |
    # Some machines require that the protocol be explicitly set to Tls12
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    Install-Module -Name UnitySetup -Scope CurrentUser -Force
  displayName: Install unitysetup.powershell

- powershell: |
    Write-Host "======================= EditMode Tests ======================="

    $logFile = New-Item -Path .\editmode-test-run.log -ItemType File -Force

    # Uses unitysetup.powershell
    try {
        Start-UnityEditor -Project "$(Get-Location)" -Version ${{ parameters.UnityVersion }} -RunTests -TestPlatform EditMode -EditorTestsResultFile ".\test-editmode-default.xml" -BatchMode -Wait -LogFile "$($logFile.FullName)" -BuildTarget StandaloneWindows64 -AdditionalArguments "-CacheServerIPAddress ${Env:COG-UnityCache-WUS2-01}"
    }
    finally {
        if (Test-Path $logFile.FullName)
        {
            Write-Output '====================================================='
            Write-Output '           Begin Unity Player Log                    '
            Write-Output '====================================================='

            Get-Content $logFile.FullName

            Write-Output '====================================================='
            Write-Output '           End Unity Player Log                      '
            Write-Output '====================================================='
        }
        else
        {
            Write-Output 'Unity Player Log Missing!'
        }
    }
  displayName: 'Run EditMode tests'

- powershell: |
    Write-Host "======================= PlayMode Tests ======================="

    $logFile = New-Item -Path .\playmode-test-run.log -ItemType File -Force

    # Uses unitysetup.powershell
    try {
        Start-UnityEditor -Project "$(Get-Location)" -Version ${{ parameters.UnityVersion }} -RunTests -TestPlatform PlayMode -EditorTestsResultFile ".\test-playmode-default.xml" -BatchMode -Wait -LogFile "$($logFile.FullName)" -BuildTarget StandaloneWindows64 -AdditionalArguments "-CacheServerIPAddress ${Env:COG-UnityCache-WUS2-01}"
    }
    finally {
        if (Test-Path $logFile.FullName)
        {
            Write-Output '====================================================='
            Write-Output '           Begin Unity Player Log                    '
            Write-Output '====================================================='

            Get-Content $logFile.FullName

            Write-Output '====================================================='
            Write-Output '           End Unity Player Log                      '
            Write-Output '====================================================='
        }
        else
        {
            Write-Output 'Unity Player Log Missing!'
        }
    }
  displayName: 'Run PlayMode tests'

- task: PublishTestResults@2
  displayName: 'Publish Test Results'
  inputs:
    testResultsFormat: NUnit
    testResultsFiles: 'test*.xml'
    failTaskOnFailedTests: true
